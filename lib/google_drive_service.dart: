import 'dart:io';
import 'package:google_sign_in/google_sign_in.dart';
import 'package:googleapis/drive/v3.dart' as drive;
import 'package:googleapis_auth/auth_io.dart';
import 'package:file_picker/file_picker.dart';
import 'package:http/http.dart' as http;
import 'package:flutter/material.dart';

class GoogleDriveService {
  // Google Sign-In instance
  final GoogleSignIn _googleSignIn = GoogleSignIn(
    scopes: ['https://www.googleapis.com/auth/drive.file'],
  );

  GoogleSignInAccount? _user;

  // Method to sign in the user
  Future<void> signIn() async {
    try {
      _user = await _googleSignIn.signIn();
      if (_user != null) {
        print("Signed in as: ${_user!.email}");
      } else {
        print("Sign-in aborted by user.");
      }
    } catch (error) {
      print("Error during sign-in: $error");
    }
  }

  // Method to check if the user is signed in
  bool isUserSignedIn() {
    return _user != null;
  }

  // Method to upload a file to Google Drive
  Future<void> uploadFile() async {
    if (_user == null) {
      print("User not signed in.");
      return;
    }

    // Pick a file from the device
    FilePickerResult? result = await FilePicker.platform.pickFiles();
    if (result != null && result.files.single.path != null) {
      File file = File(result.files.single.path!);
      print("File selected: ${file.path}");

      // Get authentication headers from the signed-in user
      final authHeaders = await _user?.authHeaders;
      if (authHeaders == null) {
        print("Failed to get auth headers.");
        return;
      }

      // Create authenticated client
      final authenticateClient = authenticatedClient(http.Client(), authHeaders);

      // Google Drive API instance
      final driveApi = drive.DriveApi(authenticateClient);

      // Create metadata for the file and upload it to Google Drive
      drive.File driveFile = drive.File();
      driveFile.name = result.files.single.name;

      var response = await driveApi.files.create(
        driveFile,
        uploadMedia: drive.Media(file.openRead(), file.lengthSync()),
      );

      print("File uploaded to Google Drive: ${response.name}");
    } else {
      print("No file selected.");
    }
  }
}
